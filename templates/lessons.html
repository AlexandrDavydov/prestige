{% extends "base.html" %}
{% block title %}–ó–∞–Ω—è—Ç–∏—è{% endblock %}
{% block content %}
<h1>üßò‚Äç‚ôÄÔ∏è –ó–∞–Ω—è—Ç–∏—è</h1>
<a href="{{ url_for('add_lesson') }}" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ">
    <img src="{{ url_for('static', filename='images/add_icons.gif') }}"
         alt="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ"
         width="50"
         height="50">
</a>
<form method="get" action="{{ url_for('lessons') }}">
    <label for="status_filter">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
    <select name="status_filter" id="status_filter" onchange="this.form.submit()">
        <option value="–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ" {% if status_filter=='–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ' %}selected{% endif %}>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
        <option value="–°–æ—Å—Ç–æ—è–ª–æ—Å—å" {% if status_filter=='–°–æ—Å—Ç–æ—è–ª–æ—Å—å' %}selected{% endif %}>–°–æ—Å—Ç–æ—è–ª–æ—Å—å</option>
        <option value="–í—Å–µ" {% if status_filter=='–í—Å–µ' %}selected{% endif %}>–í—Å–µ</option>
    </select>
</form>
<div>
    –®–∞–±–ª–æ–Ω—ã:
    <select id="lesson_template_select">
        {% for l in lesson_templates %}
        <option value="{{ l.id }}">{{ l.template_name }}</option>
        {% endfor %}
    </select>
    <a href="#" class="btn" onclick="addFromTemplate()">üìã –î–æ–±–∞–≤–∏—Ç—å –∏–∑ —à–∞–±–ª–æ–Ω–∞</a>
</div>

<table border="1">
    {% for l in lessons %}
    <tr class="table-title">
        <td colspan="6"><i>{{ l.date | ru_date }}</i> | {{ l.lesson_name }}</td>
    </tr>
    <tr class="section_title">
        <td colspan="6"><span style="font-weight: normal; font-style: normal;">—Ç—Ä–µ–Ω–µ—Ä:</span>
            {% for c in coaches %}
            {% if c.id == l.coach_id %}
            {{ c.last_name }} {{ c.first_name }}
            {% endif %}
            {% endfor %}
            <span style="font-weight: normal; font-style: normal;">  |  —Å—Ç–∞—Ç—É—Å:</span>
            {{ l.status }}
        </td>
    </tr>
    <tr class="section_sub_title">
        <th>–£—á–µ–Ω–∏–∫–∏</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    <tr>
        <td>
            {% set ids = l.student_ids.split(',') %}
            {% for s in students %}
            {% if s.id|string in ids %}
            {{ s.last_name }} {{ s.first_name }}<br>
            {% endif %}
            {% endfor %}
        </td>
        <td>
            <a href="{{ url_for('lesson_done', lesson_id=l.id) }}" title="–°–æ—Å—Ç–æ—è–ª–æ—Å—å">
                <img src="{{ url_for('static', filename='images/ok_icons.gif') }}"
                     alt="–°–æ—Å—Ç–æ—è–ª–æ—Å—å"
                     width="50"
                     height="50">
            </a>
            <a href="{{ url_for('edit_lesson', lesson_id=l.id) }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                <img src="{{ url_for('static', filename='images/edit_icons.gif') }}"
                     alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                     width="50"
                     height="50">
            </a>
            <a href="#" onclick="downloadFile_docx({{ l.id }})" title="–°–∫–∞—á–∞—Ç—å –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—É">
                <img src="{{ url_for('static', filename='images/table_icons.gif') }}"
                     alt="–°–∫–∞—á–∞—Ç—å –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—É"
                     width="50"
                     height="50">
            </a>
            <a href="#" href="#" onclick="downloadFile_png({{ l.id }})" title="–°–∫–∞—á–∞—Ç—å –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É">
                <img src="{{ url_for('static', filename='images/picture_icons.gif') }}"
                     alt="–°–∫–∞—á–∞—Ç—å –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É"
                     width="50"
                     height="50">
            </a>
            <a href="#" class="delete-btn" data-url="{{ url_for('delete_lesson', lesson_id=l.id) }}" title="–£–¥–∞–ª–∏—Ç—å">
                <img src="{{ url_for('static', filename='images/delete_icons.gif') }}"
                     alt="–£–¥–∞–ª–∏—Ç—å"
                     width="50"
                     height="50">
            </a>
        </td>
    </tr>
    {% endfor %}
</table>
<script>
    function addFromTemplate() {
        const select = document.getElementById("lesson_template_select");
        const id = select.value;
        window.location.href = `/lesson_template/add/${id}`;
    }

    function downloadFile_docx(lesson_id) {
        const formData = new FormData();
        formData.append("lesson_id", lesson_id);
        fetch("/download_docx", {
            method: "POST",
            body: formData
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "report.docx";
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            });
    }

    function downloadFile_png(lesson_id) {
        const formData = new FormData();
        formData.append("lesson_id", lesson_id);
        fetch("/download_png", {
            method: "POST",
            body: formData
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "report.png";
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            });
    }
</script>
{% endblock %}

